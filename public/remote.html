<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Remote</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="start-overlay" class="start-overlay"><button class="btn-primary" onclick="startRemote()">PRIPOJI콗 SA</button></div>
    <div id="status" style="position:absolute;top:10px;right:10px;background:black;color:lime;padding:5px;z-index:999;">Stav: 캛ak치m</div>

    <div class="remote-layout">
        <div class="video-grid">
            <div class="video-box full-screen-share" id="share-box"><video id="sharedScreenVideo" autoplay playsinline></video></div>
            <div class="video-box"><video id="roomVideo" autoplay playsinline></video><div class="label">Miestnos콘</div></div>
            <div class="video-box"><video id="myVideo" autoplay playsinline muted></video><div class="label">Ja</div></div>
        </div>
        <div class="control-bar">
            <button class="control-btn blue" id="shareBtn" onclick="toggleShare()">游닠</button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const rawId = params.get('id'); // remote2
        // Zist칤me 캜칤slo monitora (remote2 -> 2)
        const targetMonNum = rawId.replace('remote', ''); 

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 2,
            config: { 'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ]}
        };

        const socket = io('/');
        let peer, myStream, sharePeer;
        let isSharing = false;

        function log(msg) { document.getElementById('status').innerText = msg; console.log(msg); }

        function startRemote() {
            document.getElementById('start-overlay').style.display = 'none';
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                myStream = s;
                document.getElementById('myVideo').srcObject = s;
                initPeer();
            });
        }

        function initPeer() {
            peer = new Peer(peerConfig);
            peer.on('open', id => {
                log("Pripojen칳 na cloud. H쬬d치m monitor...");
                // 1. Op칳tame sa servera na ID monitora
                socket.emit('get-monitor-id', targetMonNum);
            });

            // 2. Server odpovie (ak u monitor be쮂)
            socket.on('monitor-id-response', (monitorPeerId) => {
                log("Monitor n치jden칳: " + monitorPeerId + ". Vol치m...");
                callMonitor(monitorPeerId);
            });

            // 3. Alebo ak sa monitor pripoj칤 nesk칪r
            socket.on('monitor-available', (num, monitorPeerId) => {
                if (num === targetMonNum) {
                    log("Monitor sa pr치ve pripojil. Vol치m...");
                    callMonitor(monitorPeerId);
                }
            });

            peer.on('call', call => {
                call.answer();
                call.on('stream', s => {
                    document.getElementById('sharedScreenVideo').srcObject = s;
                    document.getElementById('share-box').style.display = 'block';
                });
            });
        }

        function callMonitor(id) {
            const call = peer.call(id, myStream);
            if(call) {
                call.on('stream', rs => {
                    log("Spojenie 칰spe코n칠!");
                    document.getElementById('roomVideo').srcObject = rs;
                });
                call.on('error', e => log("Call error: " + e));
            }
        }

        // Zjednodu코en칠 zdie쬬nie
        function toggleShare() {
            if(isSharing) { location.reload(); return; } // Najr칳chlej코칤 stop je reload
            
            navigator.mediaDevices.getDisplayMedia({ video: {cursor:"always"}, audio:false }).then(stream => {
                isSharing = true;
                document.getElementById('shareBtn').style.background = 'green';
                
                sharePeer = new Peer(peerConfig);
                sharePeer.on('open', () => {
                    socket.emit('start-share');
                    
                    // Z칤skame ID BigScreenu
                    socket.emit('get-bigscreen-id');
                    socket.on('bigscreen-id-response', (bsId) => sharePeer.call(bsId, stream));
                    
                    // Tu by sme museli rie코i콘 broadcast ostatn칳m, 
                    // pre jednoduchos콘 to teraz posiela len na BigScreen
                });
            });
        }
    </script>
</body>
</html>