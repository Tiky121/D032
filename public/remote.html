<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>Remote Meeting</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
</head>
<body>
    <!-- Start Button -->
    <div id="start-overlay" class="start-overlay">
        <h2 style="margin-bottom: 20px;">Pripravený na pripojenie?</h2>
        <button class="btn-primary" onclick="startRemote()">PRIPOJIŤ SA</button>
    </div>

    <div class="remote-layout">
        <div class="video-grid">
            <!-- 1. Zdieľaná obrazovka (skrytá ak nikto nezdieľa) -->
            <div class="video-box full-screen-share" id="share-box">
                <video id="sharedScreenVideo" autoplay playsinline></video>
                <div class="label" style="background:red;">Zdieľaná obrazovka</div>
            </div>

            <!-- 2. Miestnosť -->
            <div class="video-box" id="room-box">
                <video id="roomVideo" autoplay playsinline></video>
                <div class="label">Miestnosť</div>
            </div>

            <!-- 3. Moja kamera -->
            <div class="video-box">
                <video id="myVideo" autoplay playsinline muted></video>
                <div class="label">Ja</div>
            </div>

            <!-- Placeholder pre ostatných (voliteľné) -->
            <div class="video-box" style="display:flex; align-items:center; justify-content:center; color:#444;">
                <span>Ostatní účastníci</span>
            </div>
        </div>

        <!-- Ovládací panel -->
        <div class="control-bar">
            <button class="control-btn red" title="Odpojiť" onclick="location.href='index.html'">
                <svg viewBox="0 0 24 24"><path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm3.54 5.46L12 12.93l-3.54-3.47-1.41 1.41L10.59 14.34l-3.54 3.47 1.41 1.41L12 15.76l3.54 3.47 1.41-1.41-3.54-3.47 3.54-3.47-1.41-1.41z"/></svg>
            </button>
            
            <!-- Tlačidlo zdieľania -->
            <button class="control-btn blue" id="shareBtn" title="Zdieľať obrazovku" onclick="toggleScreenShare()">
                <svg viewBox="0 0 24 24"><path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.11-.9-2-2-2H4c-1.11 0-2 .89-2 2v10c0 1.1.89 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>
            </button>
        </div>
        <!-- Pridaj toto niekam do body, napr. pod start-overlay -->
<div id="status-log" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; font-size: 12px; z-index: 2000; pointer-events: none;">Stav: Čakám...</div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const rawId = params.get('id'); 
        const myPeerId = `tiky-${rawId}`; 
        const targetMonitorId = `tiky-monitor-${rawId.replace('remote', '')}`;

        const isSecure = location.protocol === 'https:';
        const serverPort = location.port ? parseInt(location.port) : (isSecure ? 443 : 80);

        const peerConfig = {
            host: location.hostname,
            port: serverPort,
            path: '/peerjs',
            secure: isSecure,
            debug: 2,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { 
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443?transport=tcp",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ]
            }
        };

        const socket = io('/');
        let peer;
        let sharePeer = null;
        let isSharing = false;
        let myLocalStream = null;

        function logStatus(msg) {
            document.getElementById('status-log').innerText = msg;
            console.log(msg);
        }

        function startRemote() {
            document.getElementById('start-overlay').style.display = 'none';
            logStatus("Pripájam sa na server...");

            peer = new Peer(myPeerId, peerConfig);

            peer.on('open', id => {
                logStatus("Pripojený. ID: " + id);
                initMediaAndCall();
            });

            peer.on('error', err => logStatus("Chyba: " + err));
            
            // Odpovedanie na screen share
            peer.on('call', call => {
                call.answer();
                call.on('stream', remoteStream => {
                    const video = document.getElementById('sharedScreenVideo');
                    video.srcObject = remoteStream;
                    document.getElementById('share-box').style.display = 'block';
                });
            });
        }

        function initMediaAndCall() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                myLocalStream = stream;
                document.getElementById('myVideo').srcObject = stream;
                socket.emit('join-room', myPeerId, 'remote');
                
                // Pokus o volanie
                attemptCall();
            })
            .catch(err => {
                logStatus("Chyba mikrofónu/kamery! " + err);
                // Fallback - skúsime aspoň video bez zvuku ak mikrofón zlyhal
                navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(s => {
                    myLocalStream = s;
                    document.getElementById('myVideo').srcObject = s;
                    attemptCall();
                });
            });
        }

        function attemptCall() {
            logStatus("Volám monitor: " + targetMonitorId + "...");
            
            if(!myLocalStream) return;

            const call = peer.call(targetMonitorId, myLocalStream);
            
            if(call) {
                call.on('stream', roomStream => {
                    logStatus("Spojenie úspešné!");
                    document.getElementById('roomVideo').srcObject = roomStream;
                });
                
                call.on('close', () => logStatus("Hovor ukončený monitorom."));
                call.on('error', (e) => logStatus("Chyba hovoru: " + e));
                
                // Ak sa do 5 sekúnd nič nestane, skús znova
                setTimeout(() => {
                    if(!document.getElementById('roomVideo').srcObject) {
                        logStatus("Monitor neodpovedá, skúšam znova...");
                        attemptCall();
                    }
                }, 5000);
            } else {
                logStatus("Nepodarilo sa inicializovať hovor.");
            }
        }

        // Funkcia pre manuálne tlačidlo (ak by si ho chcel pridať)
        function manualReconnect() {
            if(peer) peer.destroy();
            startRemote();
        }

        // --- ZDIEĽANIE (Rovnaké ako predtým, len config update) ---
        function toggleScreenShare() {
            const btn = document.getElementById('shareBtn');
            if (isSharing) { stopSharing(); btn.classList.remove('active-share'); return; }

            navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: false })
            .then(screenStream => {
                isSharing = true;
                btn.classList.add('active-share');
                const shareId = `tiky-sharer-${rawId}`;
                sharePeer = new Peer(shareId, peerConfig);

                sharePeer.on('open', () => {
                    socket.emit('start-share', shareId);
                    sharePeer.call('tiky-big-screen', screenStream);
                    ['remote1', 'remote2', 'remote3'].forEach(rid => {
                        if(rid !== rawId) sharePeer.call(`tiky-${rid}`, screenStream);
                    });
                });

                screenStream.getVideoTracks()[0].onended = () => {
                    stopSharing();
                    btn.classList.remove('active-share');
                };
            });
        }

        function stopSharing() {
            if (sharePeer) { sharePeer.destroy(); sharePeer = null; }
            socket.emit('stop-share');
            isSharing = false;
        }
    </script>
</body>
</html>