<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remote PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Inline štýly pre špecifické gridy remote -->
    <style>
         /* Zdieľaná obrazovka (Full overlay) */
        .full-screen-share {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; background: #000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>
    <div id="start-overlay">
        <img src="logo.svg" alt="UMIKT" class="logo-img">
        <h2 style="color:var(--text-gray); font-weight:400;">Prihlásený ako: <span id="user-id-display" style="color:var(--dark-blue); font-weight:bold;">...</span></h2>
        <br>
        <button class="btn-primary" onclick="startRemote()">PRIPOJIŤ SA</button>
    </div>

    <div class="full-screen-share" id="share-box">
        <h2 style="color:#888; position:absolute;">Načítavam zdieľanie...</h2>
        <video id="sharedScreenVideo" autoplay playsinline></video>
        <div class="label" style="background:var(--danger); color:white; top:10px; left:10px; bottom:auto;">Zdieľaná obrazovka</div>
        <button class="btn btn-red" style="position:absolute; top:10px; right:10px;" onclick="location.reload()">❌</button>
    </div>

    <div class="video-container">
        <!-- 1. Sekcia MIESTNOSŤ (Hore) -->
        <div class="video-box" style="grid-column: span 1;">
            <video id="roomVideo" autoplay playsinline></video>
            <div class="label">Miestnosť</div>
        </div>
        <div class="video-box" style="grid-column: span 1;">
            <video id="myVideo" autoplay playsinline muted></video>
            <div class="label">Ja</div>
        </div>
        
        <!-- 2. Sekcia OSTATNÍ (Dynamický Grid dole) -->
        <!-- Tento kontajner musíme vložiť do gridu layoutu -->
        <!-- Pre zjednodušenie layoutu v CSS sme mali grid. Tu to spravíme tak, že kolegovia sa pridajú ako ďalšie boxy -->
        <div id="remotes-placeholder" style="display:contents;">
            <!-- Tu sa objavia kolegovia -->
        </div>
    </div>

    <div class="control-bar">
        <button class="btn" id="muteBtn" onclick="toggleMute()"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
        <button class="btn btn-red" onclick="location.reload()"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.81 7.46 7 12 7s8.66 1.81 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg></button>
        <button class="btn btn-blue" id="shareBtn" onclick="toggleShare()"><svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12zm-2-9H5v7h14V8z"/></svg></button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const rawId = params.get('id'); 
        const targetMonNum = rawId.replace('remote', ''); 
        document.getElementById('user-id-display').innerText = rawId;

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 0,
            config: { 
                iceTransportPolicy: 'all', 
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
                ]
            }
        };

        const socket = io('/');
        let peer, myStream, sharePeer, isSharing = false, isMuted = false;
        let connectedPeers = {}; 

        function startRemote() {
            document.getElementById('start-overlay').style.display = 'none';
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                myStream = s; document.getElementById('myVideo').srcObject = s; initPeer();
            }).catch(e => alert("Povoľ kameru!"));
        }

        function toggleMute() {
            if(!myStream) return;
            isMuted = !isMuted;
            myStream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('muteBtn').classList.toggle('muted-active', isMuted);
        }

        function initPeer() {
            peer = new Peer(peerConfig);
            peer.on('open', id => {
                // 1. Registrácia a Mesh
                socket.emit('register-remote-user', id);
                socket.emit('get-monitor-id', targetMonNum);
                if (targetMonNum !== '2') socket.emit('get-monitor-id', '2');
            });

            // LOGIKA MIESTNOSTI (Splitter)
            socket.on('monitor-id-response', (num, mid) => handleMonitorFound(num, mid));
            socket.on('monitor-available', (num, mid) => handleMonitorFound(num, mid));

            // LOGIKA KOLEGOV (Mesh)
            socket.on('new-remote-joined', (remotePeerId) => connectToRemoteUser(remotePeerId));
            socket.on('existing-remotes', (users) => users.forEach(uid => connectToRemoteUser(uid)));
            socket.on('remote-disconnected', (remotePeerId) => removeRemoteVideo(remotePeerId));

            // PRÍCHODZIE HOVORY
            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', remoteStream => addRemoteVideo(call.peer, remoteStream));
            });

            // ZDIEĽANIE
            socket.on('stopped-sharing', () => {
                document.getElementById('share-box').style.display = 'none';
                document.getElementById('sharedScreenVideo').srcObject = null;
                if(isSharing) { isSharing = false; document.getElementById('shareBtn').classList.remove('share-active'); }
            });
        }

        function connectToRemoteUser(remoteId) {
            if(connectedPeers[remoteId]) return;
            const call = peer.call(remoteId, myStream);
            connectedPeers[remoteId] = call;
            call.on('stream', rs => addRemoteVideo(remoteId, rs));
            call.on('error', () => removeRemoteVideo(remoteId));
            call.on('close', () => removeRemoteVideo(remoteId));
        }

        function addRemoteVideo(peerId, stream) {
            if (document.getElementById('video-' + peerId)) return; 

            // Vytvoríme nový video box
            const div = document.createElement('div');
            div.className = 'video-box';
            div.id = 'box-' + peerId;
            
            const vid = document.createElement('video');
            vid.autoplay = true; vid.playsInline = true; vid.id = 'video-' + peerId; vid.srcObject = stream;
            
            const lbl = document.createElement('div');
            lbl.className = 'label';
            lbl.innerText = "Kolega";

            div.appendChild(vid);
            div.appendChild(lbl);
            
            // Pridáme do gridu
            document.querySelector('.video-container').appendChild(div);
        }

        function removeRemoteVideo(peerId) {
            const el = document.getElementById('box-' + peerId);
            if (el) el.remove();
            delete connectedPeers[peerId];
        }

        function handleMonitorFound(num, mid) {
            if (num === targetMonNum) {
                const vTrack = myStream.getVideoTracks()[0];
                peer.call(mid, new MediaStream([vTrack]));
            } 
            else if (num === '2' && targetMonNum !== '2') {
                const aTrack = myStream.getAudioTracks()[0];
                const call = peer.call(mid, new MediaStream([aTrack]));
                call.on('stream', rs => {
                    const v = document.getElementById('roomVideo');
                    if (v.srcObject && v.srcObject.getVideoTracks().length > 0) {
                        const a = document.createElement('audio'); a.srcObject=rs; a.autoplay=true; document.body.appendChild(a);
                    } else { v.srcObject = rs; }
                });
            }
             if (num === '2' && targetMonNum === '2') {
                const call = peer.call(mid, myStream);
                call.on('stream', rs => { document.getElementById('roomVideo').srcObject = rs; });
            }
        }

        function toggleShare() {
            if(isSharing) { if(sharePeer) { sharePeer.destroy(); sharePeer=null; } socket.emit('stop-share'); isSharing = false; document.getElementById('shareBtn').classList.remove('share-active'); return; } 
            navigator.mediaDevices.getDisplayMedia({ video: {cursor:"always"}, audio:false }).then(stream => {
                isSharing = true; document.getElementById('shareBtn').classList.add('share-active');
                sharePeer = new Peer(peerConfig);
                sharePeer.on('open', () => {
                    socket.emit('start-share');
                    socket.emit('get-bigscreen-id');
                    socket.on('bigscreen-id-response', (bsId) => sharePeer.call(bsId, stream));
                });
                stream.getVideoTracks()[0].onended = () => toggleShare();
            });
        }
    </script>
</body>
</html>