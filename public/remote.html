<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Remote Debug</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        #status {
            position:absolute; top:10px; right:10px; 
            background:rgba(0,0,0,0.8); color:lime; padding:10px; 
            z-index:999; font-size:12px; max-width: 200px;
        }
    </style>
</head>
<body>
    <div id="start-overlay" class="start-overlay"><button class="btn-primary" onclick="startRemote()">PRIPOJI≈§ SA (v2)</button></div>
    <div id="status">Stav: ƒåak√°m<br>Log: ...</div>

    <div class="remote-layout">
        <div class="video-grid">
            <div class="video-box full-screen-share" id="share-box"><video id="sharedScreenVideo" autoplay playsinline></video></div>
            <div class="video-box"><video id="roomVideo" autoplay playsinline></video><div class="label">Miestnos≈•</div></div>
            <div class="video-box"><video id="myVideo" autoplay playsinline muted></video><div class="label">Ja</div></div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const rawId = params.get('id');
        const targetMonNum = rawId.replace('remote', ''); 

        function log(msg) {
            document.getElementById('status').innerHTML = "Log:<br>" + msg;
            console.log(msg);
        }

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 2,
            config: { 
                iceTransportPolicy: 'relay', // <--- TOTO JE D√îLE≈ΩIT√â
                'iceServers': [
                    { 
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443?transport=tcp",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ]
            }
        };

        const socket = io('/');
        let peer, myStream;

        function startRemote() {
            document.getElementById('start-overlay').style.display = 'none';
            log("Zap√≠nam kameru...");
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                myStream = s;
                document.getElementById('myVideo').srcObject = s;
                initPeer();
            }).catch(e => log("Kamera chyba: " + e));
        }

        function initPeer() {
            log("Prip√°jam na Cloud...");
            peer = new Peer(peerConfig);
            
            peer.on('open', id => {
                log("‚úÖ Cloud OK. Hƒæad√°m ID Monitora " + targetMonNum + "...");
                socket.emit('get-monitor-id', targetMonNum);
            });

            socket.on('monitor-id-response', (monitorPeerId) => {
                log("üéØ Monitor n√°jden√Ω: " + monitorPeerId + "<br>Vyt√°ƒçam hovor...");
                const call = peer.call(monitorPeerId, myStream);
                handleCall(call);
            });

            socket.on('monitor-available', (num, monitorPeerId) => {
                if (num === targetMonNum) {
                    log("üîî Monitor sa pr√°ve pripojil. Vyt√°ƒçam...");
                    const call = peer.call(monitorPeerId, myStream);
                    handleCall(call);
                }
            });
            
            peer.on('error', e => log("‚ùå Peer Error: " + e));
        }

        function handleCall(call) {
            call.on('stream', rs => {
                log("üé¨ Stream prijat√Ω!");
                const v = document.getElementById('roomVideo');
                v.srcObject = rs;
                
                // Poƒçk√°me k√Ωm sa video naƒç√≠ta
                v.onloadedmetadata = () => {
                    const p = v.play();
                    if(p !== undefined) {
                        p.catch(e => {
                            log("‚ö†Ô∏è Autoplay blok: Klikni na video!");
                            // Tu by sme mohli tie≈æ zobrazi≈• overlay, 
                            // ale pre Remote staƒç√≠ alert alebo klikn√∫≈• na video
                            v.muted = true; // Sk√∫sime najprv st√≠≈°i≈• (to prehliadaƒçe dovolia)
                            v.play().then(() => {
                                log("‚ñ∂Ô∏è Hr√° st√≠≈°en√©. Klikni pre zvuk.");
                                v.muted = false; // A hneƒè sk√∫sime odti≈°i≈•
                            });
                        });
                    }
                };
            });
        }
    </script>
</body>
</html>