<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>Remote UNIVERSAL</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <!-- POU≈Ω√çVAME NAJNOV≈†IU VERZIU -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h2 style="margin-bottom: 20px; color:white;">Pripojenie: <span id="user-id-display"></span></h2>
        <button class="btn-primary" onclick="startRemote()">PRIPOJI≈§ SA</button>
    </div>

    <div id="status" style="position:absolute; top:10px; right:10px; color:lime; background:rgba(0,0,0,0.7); padding:5px; z-index:9000; font-size:12px;">Stav: ƒåak√°m</div>

    <div class="remote-layout">
        <div class="video-grid">
            <div class="video-box full-screen-share" id="share-box"><video id="sharedScreenVideo" autoplay playsinline></video></div>
            <div class="video-box"><video id="roomVideo" autoplay playsinline></video><div class="label">Miestnos≈•</div></div>
            <div class="video-box"><video id="myVideo" autoplay playsinline muted></video><div class="label">Ja</div></div>
        </div>
        
        <div class="control-bar">
            <button class="control-btn blue" id="shareBtn" onclick="toggleShare()">üì∫</button>
            <button class="control-btn red" onclick="location.reload()">‚ùå</button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const rawId = params.get('id'); 
        const targetMonNum = rawId.replace('remote', ''); 
        document.getElementById('user-id-display').innerText = rawId;

        function log(msg) { 
            document.getElementById('status').innerText = msg; 
            console.log(msg); 
        }

        // Rovnak√Ω config ako Monitor
        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 1,
            config: { 
                iceTransportPolicy: 'all', 
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
                ]
            }
        };

        const socket = io('/');
        let peer, myStream, sharePeer;
        let isSharing = false;

        function startRemote() {
            document.getElementById('start-overlay').style.display = 'none';
            log("Zap√≠nam kameru...");

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                myStream = stream;
                document.getElementById('myVideo').srcObject = stream;
                initPeer();
            })
            .catch(err => {
                log("Chyba kamery: " + err);
                alert("Povoƒæte kameru!");
            });
        }

        function initPeer() {
            peer = new Peer(peerConfig);
            
            peer.on('open', id => {
                log("Online. Hƒæad√°m Monitor " + targetMonNum + "...");
                socket.emit('get-monitor-id', targetMonNum);
            });

            // Server n√°m povie ID monitora
            socket.on('monitor-id-response', (monitorPeerId) => {
                log("Monitor n√°jden√Ω. Vol√°m...");
                callMonitor(monitorPeerId);
            });

            // Ak sa monitor pripoj√≠ nesk√¥r
            socket.on('monitor-available', (num, monitorPeerId) => {
                if (num === targetMonNum) {
                    log("Monitor pripojen√Ω. Vol√°m...");
                    callMonitor(monitorPeerId);
                }
            });

            peer.on('call', call => {
                call.answer();
                call.on('stream', s => {
                    const v = document.getElementById('sharedScreenVideo');
                    v.srcObject = s;
                    document.getElementById('share-box').style.display = 'block';
                    v.play().catch(e => console.log(e));
                });
            });
            
             peer.on('error', err => log("Error: " + err.type));
        }

        function callMonitor(id) {
            const call = peer.call(id, myStream);
            
            call.on('stream', rs => {
                log("‚úÖ SPOJENIE!");
                const v = document.getElementById('roomVideo');
                v.srcObject = rs;
                v.play().catch(e => {
                    log("Klikni na video pre spustenie!");
                    v.muted = true;
                    v.play(); // Fallback muted play
                });
            });
            
            call.on('error', e => log("Call failed: " + e));
        }

        function toggleShare() {
            if(isSharing) { location.reload(); return; } 
            
            navigator.mediaDevices.getDisplayMedia({ video: {cursor:"always"}, audio:false })
            .then(stream => {
                isSharing = true;
                document.getElementById('shareBtn').style.background = '#00ff00';
                
                sharePeer = new Peer(peerConfig);
                sharePeer.on('open', () => {
                    socket.emit('start-share');
                    socket.emit('get-bigscreen-id');
                    socket.on('bigscreen-id-response', (bsId) => sharePeer.call(bsId, stream));
                });
                
                stream.getVideoTracks()[0].onended = () => location.reload();
            });
        }
    </script>
</body>
</html>