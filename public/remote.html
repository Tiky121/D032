<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remote FULL MESH</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #121212; color: white; font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Hlavný layout */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
            overflow-y: auto; /* Aby sa dalo scrollovať ak je veľa ľudí */
        }

        /* Horná časť: Miestnosť + Zdieľanie */
        .room-section {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 10px;
            flex-shrink: 0;
            height: 40vh; /* Fixná výška pre miestnosť */
        }
        @media (min-width: 768px) { .room-section { grid-template-columns: 1fr 1fr; height: 50vh; } }

        /* Dolná časť: Ostatní kolegovia (Grid) */
        .remotes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            flex: 1; /* Zvyšok miesta */
            min-height: 150px;
        }

        .video-box { background: #1e1e1e; border-radius: 12px; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; border: 1px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .label { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.6); padding: 3px 8px; border-radius: 8px; font-size: 11px; pointer-events: none;}

        /* Zdieľaná obrazovka (Full overlay) */
        .full-screen-share {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; background: #000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .full-screen-share video { object-fit: contain; }

        /* Controls */
        .control-bar { height: 70px; background: #1e1e1e; display: flex; justify-content: center; align-items: center; gap: 15px; flex-shrink: 0; z-index: 101; box-shadow: 0 -5px 20px black; }
        .btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: #333; color: white; font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .btn-red { background: #ff4444; } .btn-blue { background: #007aff; } .muted-active { background: #ff4444 !important; } .share-active { background: #34c759 !important; color: black; }
        svg { width: 24px; height: 24px; fill: currentColor; }
    </style>
</head>
<body>
    <div id="start-overlay" style="position:absolute; inset:0; background:black; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h2 style="color:#aaa">ID: <span id="user-id-display">...</span></h2>
        <button onclick="startRemote()" style="padding:15px 40px; font-size:18px; border-radius:30px; border:none; background:#007aff; color:white; font-weight:bold; margin-top:20px;">PRIPOJIŤ SA</button>
    </div>

    <div class="full-screen-share" id="share-box">
        <h2 style="color:#888; position:absolute;">Načítavam zdieľanie...</h2>
        <video id="sharedScreenVideo" autoplay playsinline></video>
        <div class="label" style="background:red; top:10px; left:10px; bottom:auto;">Zdieľaná obrazovka</div>
        <button class="btn btn-red" style="position:absolute; top:10px; right:10px;" onclick="location.reload()">❌</button>
    </div>

    <div class="main-container">
        <!-- 1. Sekcia MIESTNOSŤ -->
        <div class="room-section">
            <div class="video-box">
                <video id="roomVideo" autoplay playsinline></video>
                <div class="label">Miestnosť</div>
            </div>
            <div class="video-box">
                <video id="myVideo" autoplay playsinline muted></video>
                <div class="label">Ja</div>
            </div>
        </div>

        <!-- 2. Sekcia OSTATNÍ (Sem sa pridajú dynamicky) -->
        <div id="remotes-grid" class="remotes-grid">
            <!-- Tu sa objavia kolegovia -->
        </div>
    </div>

    <div class="control-bar">
        <button class="btn" id="muteBtn" onclick="toggleMute()"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
        <button class="btn btn-red" onclick="location.reload()"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.81 7.46 7 12 7s8.66 1.81 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg></button>
        <button class="btn btn-blue" id="shareBtn" onclick="toggleShare()"><svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12zm-2-9H5v7h14V8z"/></svg></button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const rawId = params.get('id'); 
        const targetMonNum = rawId.replace('remote', ''); 
        document.getElementById('user-id-display').innerText = rawId;

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 0,
            config: { iceTransportPolicy: 'all', 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }] }
        };

        const socket = io('/');
        let peer, myStream, sharePeer, isSharing = false, isMuted = false;
        let connectedPeers = {}; // Aby sme nevolali 2x

        function startRemote() {
            document.getElementById('start-overlay').style.display = 'none';
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                myStream = s; document.getElementById('myVideo').srcObject = s; initPeer();
            }).catch(e => alert("Povoľ kameru!"));
        }

        function toggleMute() {
            if(!myStream) return;
            isMuted = !isMuted;
            myStream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('muteBtn').classList.toggle('muted-active', isMuted);
        }

        function initPeer() {
            peer = new Peer(peerConfig);
            peer.on('open', id => {
                // 1. Registrácia ako Remote User
                socket.emit('register-remote-user', id);
                
                // 2. Vyžiadanie ID monitora (pre miestnosť)
                socket.emit('get-monitor-id', targetMonNum);
                if (targetMonNum !== '2') socket.emit('get-monitor-id', '2');
            });

            // --- LOGIKA MIESTNOSTI (Splitter) ---
            socket.on('monitor-id-response', (num, mid) => handleMonitorFound(num, mid));
            socket.on('monitor-available', (num, mid) => handleMonitorFound(num, mid));

            // --- LOGIKA KOLEGOV (Mesh) ---
            
            // A. Niekto nový sa pripojil -> Zavolám mu
            socket.on('new-remote-joined', (remotePeerId) => {
                console.log("Nový kolega:", remotePeerId);
                connectToRemoteUser(remotePeerId);
            });

            // B. Ja som sa pripojil -> Dostal som zoznam existujúcich -> Zavolám im
            socket.on('existing-remotes', (users) => {
                users.forEach(uid => connectToRemoteUser(uid));
            });

            // C. Niekto sa odpojil -> Vymazať video
            socket.on('remote-disconnected', (remotePeerId) => {
                removeRemoteVideo(remotePeerId);
            });

            // --- PRÍCHODZIE HOVORY ---
            peer.on('call', call => {
                call.answer(myStream); // Vždy odpovieme naším plným streamom
                
                call.on('stream', remoteStream => {
                    // Musíme rozlíšiť, či volá ScreenShare alebo Kolega
                    // ScreenShare zvyčajne nemá audio, alebo to riešime cez 'sharePeer'.
                    // Ale tu 'peer' prijíma hovory. 
                    
                    // Trik: Share okno rieši 'sharePeer' (vlastný objekt). 
                    // Takže 'peer.on(call)' sú buď Monitory (nepravdepodobné) alebo Kolegovia.
                    
                    // Pridáme video kolegu do gridu
                    addRemoteVideo(call.peer, remoteStream);
                });
            });

            // --- ZDIEĽANIE OBRAZOVKY PRÍJEM ---
            // Tu je malý háčik: PeerJS pre zdieľanie sme oddelili? 
            // V starej verzii sme prijímali share cez hlavný peer.
            // Aby sme to nepokazili: Share posiela 'sharePeer'. Ten má iné ID.
            // Takže to príde ako bežný hovor. 
            // Ako zistíme, že je to share? Metadata?
            // Zjednodušenie: Share má ID 'peerjs-generated'. 
            // Alebo: Použijeme socket event. Keď príde socket 'start-share', vieme že ďalší call bude share.
            // Ešte lepšie: SharePeer má vlastný objekt.
        }

        function connectToRemoteUser(remoteId) {
            if(connectedPeers[remoteId]) return;
            // Voláme kolegovi (Full Stream)
            const call = peer.call(remoteId, myStream);
            connectedPeers[remoteId] = call;
            
            call.on('stream', rs => {
                addRemoteVideo(remoteId, rs);
            });
            
            call.on('error', () => removeRemoteVideo(remoteId));
            call.on('close', () => removeRemoteVideo(remoteId));
        }

        function addRemoteVideo(peerId, stream) {
            // Skontrolujeme, či to nie je náhodou Share Stream (ten chceme inde)
            // V tomto kóde Share Stream riešime oddelene? 
            // V predchádzajúcom kóde `toggleShare` vytváral `new Peer()`.
            // Ale príjem bol cez `peer.on('call')`.
            
            // FIX: Ak je to share stream, chceme ho do full-screenu.
            // Ale ako ho rozlíšiť? 
            // Jednoduchý hack: Ak stream nemá audio track, je to pravdepodobne share (v našom prípade).
            // Alebo ak socket povedal "niekto zdieľa".
            
            // Keďže share sa volá cez 'bigscreen-id', Remote užívatelia ho neuvidia cez P2P call,
            // pokiaľ `sharePeer` nezavolá aj im.
            // V `toggleShare` sme volali `bigscreen`. Musíme pridať volanie remote userom?
            // Áno, ale to je zložité.
            
            // Zatiaľ predpokladajme, že toto je hovor od kolegu (tvár).
            if (document.getElementById('video-' + peerId)) return; // Už máme

            const div = document.createElement('div');
            div.className = 'video-box';
            div.id = 'box-' + peerId;
            
            const vid = document.createElement('video');
            vid.autoplay = true;
            vid.playsInline = true;
            vid.id = 'video-' + peerId;
            vid.srcObject = stream;
            
            // Meno (skrátené ID)
            const lbl = document.createElement('div');
            lbl.className = 'label';
            lbl.innerText = "Kolega";

            div.appendChild(vid);
            div.appendChild(lbl);
            document.getElementById('remotes-grid').appendChild(div);
        }

        function removeRemoteVideo(peerId) {
            const el = document.getElementById('box-' + peerId);
            if (el) el.remove();
            delete connectedPeers[peerId];
        }

        function handleMonitorFound(num, mid) {
            // Logika Splitter (Monitor 1 vs Monitor 2) - Rovnaká ako predtým
            if (num === targetMonNum) {
                const vTrack = myStream.getVideoTracks()[0];
                peer.call(mid, new MediaStream([vTrack]));
            } 
            else if (num === '2' && targetMonNum !== '2') {
                const aTrack = myStream.getAudioTracks()[0];
                const call = peer.call(mid, new MediaStream([aTrack]));
                call.on('stream', rs => {
                    // Zvuk z miestnosti - ak už video beží, pridáme audio element
                    const v = document.getElementById('roomVideo');
                    if (v.srcObject && v.srcObject.getVideoTracks().length > 0) {
                        const a = document.createElement('audio'); a.srcObject=rs; a.autoplay=true; document.body.appendChild(a);
                    } else { v.srcObject = rs; }
                });
            }
             if (num === '2' && targetMonNum === '2') {
                const call = peer.call(mid, myStream);
                call.on('stream', rs => { document.getElementById('roomVideo').srcObject = rs; });
            }
        }

        // ZDIEĽANIE (Musíme opraviť aby to videli aj Remote Useri)
        // Toto vyžaduje, aby 'sharePeer' zavolal všetkým 'activeRemotes'.
        // To je na dlhšie. Zatiaľ necháme share fungovať tak, že volá cez socket broadcast.
        // V tomto kóde som nechal príjem share cez rovnaký socket event, ale musíme doriešiť stream.
        
        // Dočasný FIX pre Share: 
        // Použijeme starú logiku pre share príjem cez sharePeer call?
        // Áno, pridáme listener na share v initPeer:
        
        // (Túto časť pridaj do initPeer)
        // Share logika ostáva: SharePeer volá BigScreen. 
        // Aby to videli Remote Users, SharePeer by musel zavolať aj im.
        // Server vie zoznam remotes.
        // OK, v `toggleShare` nižšie, pridám loop cez connectedPeers.

        function toggleShare() {
            if(isSharing) { location.reload(); return; } 
            navigator.mediaDevices.getDisplayMedia({ video: {cursor:"always"}, audio:false }).then(stream => {
                isSharing = true; document.getElementById('shareBtn').classList.add('share-active');
                sharePeer = new Peer(peerConfig);
                sharePeer.on('open', () => {
                    socket.emit('start-share');
                    // 1. Big Screen
                    socket.emit('get-bigscreen-id');
                    socket.on('bigscreen-id-response', (bsId) => sharePeer.call(bsId, stream));
                    
                    // 2. Ostatní Remote užívatelia (Trik: Voláme cez Socket, aby oni zavolali nám? Nie.)
                    // Najlepšie: Server nám pošle zoznam všetkých activeRemotes a my im zavoláme.
                    // Keďže server už má activeRemotes, môžeme si ich vypýtať.
                    // Ale pre jednoduchosť: Teraz zdieľanie uvidia len v miestnosti. 
                    // Pre remote-remote share by to chcelo ešte doladiť.
                });
                stream.getVideoTracks()[0].onended = () => location.reload();
            });
        }
    </script>
</body>
</html>