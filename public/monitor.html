<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor AGGRESSIVE</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.8); color: lime; font-family: monospace;
            overflow-y: scroll; padding: 10px; z-index: 9000; font-size: 11px;
            pointer-events: none;
        }
        #play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; 
            justify-content: center; align-items: center; z-index: 8000; cursor: pointer;
            flex-direction: column; color: white;
        }
        #play-btn {
            font-size: 60px; margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h1>Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTI≈§ SYST√âM</button>
    </div>

    <div class="video-wrapper" style="position: relative;">
        <!-- Pridal som muted="true" priamo do HTML pre istotu -->
        <video id="mainVideo" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline muted></video>
        
        <div id="play-overlay" onclick="forcePlay()">
            <div id="play-btn">‚ñ∂</div>
            <div>KLIKNI PRE VIDEO</div>
        </div>
    </div>

    <div id="debug-log">ƒåak√°m...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2');

        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML = `<div>${new Date().toLocaleTimeString()} - ${msg}</div>` + d.innerHTML;
        }

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 2,
            config: { 
                iceTransportPolicy: 'relay', 
                'iceServers': [
                    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
                ]
            }
        };

        const socket = io('/');
        let localStream = null;
        let peer = null;

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            log("Zap√≠nam kameru...");
            navigator.mediaDevices.getUserMedia({ video: true, audio: isAudioMaster })
            .then(stream => {
                localStream = stream;
                log("Kamera OK. Init Peer...");
                initPeer();
            }).catch(err => log("‚ùå CHYBA KAMERY: " + err));
        }

        function initPeer() {
            peer = new Peer(peerConfig);

            peer.on('open', (id) => {
                log("‚úÖ ONLINE. ID: " + id);
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                log("üìû Volanie...");
                call.answer(localStream);

                call.on('stream', remoteStream => {
                    log("üé¨ Stream prijat√Ω. OKAM≈ΩIT√ù ≈†TART!");
                    const video = document.getElementById('mainVideo');
                    
                    // 1. Prirad√≠me stream
                    video.srcObject = remoteStream;
                    
                    // 2. Diagnostika trackov
                    const videoTracks = remoteStream.getVideoTracks();
                    const audioTracks = remoteStream.getAudioTracks();
                    log(`üìä Info: VideoTracks: ${videoTracks.length}, AudioTracks: ${audioTracks.length}`);
                    
                    if (videoTracks.length > 0) {
                        log(`üé• Stav videa: ${videoTracks[0].enabled ? 'Zapnut√©' : 'Vypnut√©'} / ${videoTracks[0].readyState}`);
                    }

                    // 3. AGRES√çVNY PLAY (neƒçak√°me na metadata)
                    // Najprv sk√∫sime prehra≈• st√≠≈°en√© (to funguje v≈ædy)
                    video.muted = true;
                    
                    const p = video.play();
                    if (p !== undefined) {
                        p.then(() => {
                            log("‚ñ∂Ô∏è Video be≈æ√≠ (st√≠≈°en√©).");
                            // Ak video be≈æ√≠, sk√∫sime zapn√∫≈• zvuk (ak m√° by≈•)
                            if (isAudioMaster) {
                                setTimeout(() => {
                                    video.muted = false;
                                    log("üîä Zvuk zapnut√Ω.");
                                }, 1000);
                            }
                        }).catch(error => {
                            log("‚ö†Ô∏è Play error: " + error);
                            document.getElementById('play-overlay').style.display = 'flex';
                        });
                    }
                });
            });
        }

        function forcePlay() {
            const video = document.getElementById('mainVideo');
            video.muted = !isAudioMaster;
            video.play();
            document.getElementById('play-overlay').style.display = 'none';
        }
    </script>
</body>
</html>