<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor RELAY</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.8); color: lime; font-family: monospace;
            overflow-y: scroll; padding: 10px; z-index: 9999; font-size: 11px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h1>Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTI≈§ SYST√âM</button>
    </div>
    
    <video id="mainVideo" class="video-wrapper" autoplay playsinline></video>
    <div id="debug-log">ƒåak√°m na spustenie...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2');

        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML = `<div>${new Date().toLocaleTimeString()} - ${msg}</div>` + d.innerHTML;
        }

        const peerConfig = {
            host: '0.peerjs.com', 
            port: 443, 
            secure: true, 
            debug: 2,
            config: { 
                // !!! TOTO JE KƒΩ√öƒåOV√Å ZMENA !!!
                // Prikazujeme prehliadaƒçu pou≈æ√≠va≈• LEN relay server (ob√≠de v≈°etky firewally)
                iceTransportPolicy: 'relay', 
                'iceServers': [
                    { 
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443?transport=tcp",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ]
            }
        };

        const socket = io('/');
        let localStream = null;
        let peer = null;

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            log("Zap√≠nam kameru...");

            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: isAudioMaster
            }).then(stream => {
                localStream = stream;
                log("Kamera OK. Prip√°jam na Cloud...");
                initPeer();
            }).catch(err => {
                log("‚ùå CHYBA KAMERY: " + err);
                alert("Kamera zlyhala. Skontrolujte povolenia.");
            });
        }

        function initPeer() {
            peer = new Peer(peerConfig);

            peer.on('open', (id) => {
                log("‚úÖ Monitor ONLINE. ID: " + id);
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                log("üìû Prich√°dza hovor...");
                
                // Okam≈æit√© zdvihnutie (Timeout sme odstr√°nili, lebo probl√©m bol v sieti)
                call.answer(localStream);
                log("‚ö° Hovor zdvihnut√Ω.");

                call.on('stream', remoteStream => {
                    log("üé¨ Stream prijat√Ω. Pokus o prehratie...");
                    const video = document.getElementById('mainVideo');
                    video.srcObject = remoteStream;
                    
                    // Logika pre Autoplay a Zvuk
                    if (!isAudioMaster) {
                        video.muted = true;
                    } else {
                        video.muted = false; // Monitor 2 mus√≠ ma≈• zvuk
                    }

                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            log("‚ñ∂Ô∏è Video be≈æ√≠!");
                        }).catch(error => {
                            log("‚ö†Ô∏è Autoplay error: " + error);
                            // Ak zlyh√° autoplay so zvukom, sk√∫sime to st√≠≈°i≈• (fallback)
                            if (isAudioMaster) {
                                log("‚ö†Ô∏è Sk√∫≈°am prehra≈• st√≠≈°en√©...");
                                video.muted = true;
                                video.play();
                            }
                        });
                    }
                });

                call.on('error', err => log("‚ùå Chyba v hovore: " + err));
                
                call.peerConnection.onconnectionstatechange = () => {
                    log("üì° Stav siete: " + call.peerConnection.connectionState);
                };
            });

            peer.on('error', err => {
                log("‚ùå Peer Error: " + err);
                if (err.type === 'peer-unavailable' || err.type === 'network' || err.type === 'socket-error') {
                    log("üîÑ Reconnecting...");
                    peer.reconnect();
                }
            });
        }
    </script>
</body>
</html>