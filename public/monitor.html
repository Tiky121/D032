<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor Stable</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        /* Skryjeme log ak nechce≈° aby zavadzal, alebo ho nech√°me pre istotu */
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.5); color: white; font-family: monospace;
            overflow-y: scroll; padding: 5px; z-index: 9999; font-size: 10px;
            pointer-events: none; /* Aby sa dalo klika≈• cez to */
        }
    </style>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h1>Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTI≈§ SYST√âM</button>
    </div>
    
    <!-- Video mus√≠ ma≈• playsinline a muted pre autoplay policy -->
    <video id="mainVideo" class="video-wrapper" autoplay playsinline muted></video>
    
    <div id="debug-log">Syst√©m pripraven√Ω...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2');

        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML = `<div>${new Date().toLocaleTimeString()} - ${msg}</div>` + d.innerHTML;
        }

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 2,
            config: { 'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ]}
        };

        const socket = io('/');
        let localStream = null;
        let peer = null;

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            log("≈†tartujem kameru...");

            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: isAudioMaster
            }).then(stream => {
                localStream = stream;
                log("Kamera be≈æ√≠. Prip√°jam na Cloud...");
                initPeer();
            }).catch(err => {
                log("CHYBA KAMERY: " + err);
                alert("Kamera zlyhala: " + err);
            });
        }

        function initPeer() {
            peer = new Peer(peerConfig);

            peer.on('open', (id) => {
                log("‚úÖ Monitor ONLINE (ID: " + id + ")");
                // Registr√°cia na na≈°om serveri
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                log("üìû Prich√°dza hovor...");

                // === KƒΩ√öƒåOV√Å OPRAVA ===
                // ƒåak√°me 1 sekundu, k√Ωm sa spojenie stabilizuje, a≈æ potom dv√≠hame
                setTimeout(() => {
                    if (!localStream) {
                        log("‚ùå Chyba: Nem√°m kameru, nem√¥≈æem zdvihn√∫≈•.");
                        return;
                    }

                    log("‚ö° Dv√≠ham hovor (Answer)...");
                    call.answer(localStream); // Odpovieme na≈°ou kamerou

                    // Spracovanie prich√°dzaj√∫ceho videa
                    call.on('stream', remoteStream => {
                        log("üé¨ Prij√≠mam video!");
                        const video = document.getElementById('mainVideo');
                        video.srcObject = remoteStream;
                        video.muted = !isAudioMaster; // Ak nie som master, ticho
                        
                        const p = video.play();
                        if (p !== undefined) {
                            p.catch(e => log("‚ö†Ô∏è Autoplay blokovan√Ω: " + e));
                        }
                    });

                    call.on('error', err => log("‚ùå Chyba hovoru: " + err));
                    call.on('close', () => log("üîå Hovor ukonƒçen√Ω"));

                }, 1000); // 1000ms = 1 sekunda oneskorenie
            });

            peer.on('error', err => {
                log("‚ùå Peer Error: " + err);
                // Ak je to kritick√° chyba, sk√∫sime reconnect po chv√≠li
                if (err.type === 'peer-unavailable' || err.type === 'network') {
                    setTimeout(() => peer.reconnect(), 2000);
                }
            });
            
            peer.on('disconnected', () => {
                log("‚ö†Ô∏è Odpojen√Ω, reconnecting...");
                peer.reconnect();
            });
        }
    </script>
</body>
</html>