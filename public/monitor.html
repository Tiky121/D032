<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor MIXER</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: black; overflow: hidden; font-family: sans-serif; }
        .video-wrapper { position: relative; width: 100vw; height: 100vh; }
        
        #waiting-screen {
            position: absolute; inset: 0; background: #121212; color: #555;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;
        }
        .pulse-icon { font-size: 80px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        #play-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: none; 
            justify-content: center; align-items: center; z-index: 20; cursor: pointer;
            flex-direction: column; color: white;
        }
        #play-btn { font-size: 60px; margin-bottom: 10px; color: #00aaff; }
        #debug-log { position: absolute; bottom: 0; left: 0; color: gray; font-size: 10px; padding: 5px; z-index: 30;}
        
        /* Kontajner pre audio elementy (neviditeÄ¾nÃ½) */
        #audio-mixer { display: none; }
    </style>
</head>
<body>
    <div id="start-overlay" style="position:absolute; inset:0; background:black; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="color:white">Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()" style="padding:15px 30px; font-size:20px; cursor:pointer;">SPUSTIÅ¤</button>
    </div>

    <div class="video-wrapper">
        <div id="waiting-screen">
            <div class="pulse-icon">ðŸ“¡</div>
            <h2>ÄŒakÃ¡m na pripojenie...</h2>
        </div>

        <video id="mainVideo" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline muted></video>
        
        <div id="play-overlay" onclick="forcePlay()">
            <div id="play-btn">â–¶</div>
            <h3>Klikni pre obraz/zvuk</h3>
        </div>
    </div>
    
    <!-- Tu sa budÃº pridÃ¡vaÅ¥ audio stopy ostatnÃ½ch -->
    <div id="audio-mixer"></div>

    <div id="debug-log">Ready.</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2'); // Monitor 2 je CENTRÃLA

        function log(msg) { document.getElementById('debug-log').innerText = msg; console.log(msg); }

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 1,
            config: { iceTransportPolicy: 'all', 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }] }
        };

        const socket = io('/');
        let localStream, peer;
        
        // UkladÃ¡me si hovory, aby sme ich vedeli manaÅ¾ovaÅ¥
        let activeCalls = {}; 

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            // Monitor 2 mÃ¡ audio zapnutÃ©, ostatnÃ© vypnutÃ©
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: isAudioMaster })
            .then(stream => {
                localStream = stream;
                initPeer();
            }).catch(e => alert("Chyba kamery: " + e));
        }

        function initPeer() {
            peer = new Peer(peerConfig);
            peer.on('open', id => {
                log("ID: " + id);
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                log("PrichÃ¡dza hovor od: " + call.peer);
                call.answer(localStream);
                
                // UloÅ¾Ã­me hovor
                activeCalls[call.peer] = call;

                call.on('stream', remoteStream => {
                    handleIncomingStream(call.peer, remoteStream);
                });

                call.on('close', () => handleDisconnect(call.peer));
                call.on('error', () => handleDisconnect(call.peer));
            });
        }

        function handleIncomingStream(peerId, stream) {
            // ZistÃ­me, Äi je to "nÃ¡Å¡" Älovek (podÄ¾a ID)
            // Remote IDÄka vyzerajÃº napr. "peerjs-generated-id" ale my sa spoliehame na logiku Remote strany
            // Ak som Monitor X, a volÃ¡ mi Remote X, chcem video.
            // Ak som Monitor 2, a volÃ¡ mi Remote 1 alebo 3, chcem IBA AUDIO.

            // Logika: Remote strana poÅ¡le video track iba svojmu monitoru.
            // TakÅ¾e mÃ´Å¾eme skontrolovaÅ¥, Äi stream obsahuje video track.
            
            const hasVideo = stream.getVideoTracks().length > 0;

            if (hasVideo) {
                // Toto je HLAVNÃ video hovor pre tento monitor
                log("PrijatÃ½ VIDEO stream.");
                document.getElementById('waiting-screen').style.display = 'none';
                const video = document.getElementById('mainVideo');
                video.srcObject = stream;
                attemptPlay(video);
            } else {
                // Toto je iba AUDIO hovor (pre Monitor 2 od ostatnÃ½ch)
                if (isAudioMaster) {
                    log("PrijatÃ½ AUDIO stream (Mixer).");
                    addAudioToMixer(peerId, stream);
                }
            }
        }

        function addAudioToMixer(peerId, stream) {
            // Skontrolujeme Äi uÅ¾ tam nie je
            let existingAudio = document.getElementById('audio-' + peerId);
            if (existingAudio) return;

            const audio = document.createElement('audio');
            audio.id = 'audio-' + peerId;
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.playsInline = true;
            // Audio Master musÃ­ prehraÅ¥ zvuk
            document.getElementById('audio-mixer').appendChild(audio);
            
            audio.play().catch(e => console.log("Autoplay audio block:", e));
        }

        function handleDisconnect(peerId) {
            log("OdpojenÃ½: " + peerId);
            
            // OdstrÃ¡niÅ¥ z mixÃ©ra
            const audioEl = document.getElementById('audio-' + peerId);
            if (audioEl) audioEl.remove();

            // Ak to bol hlavnÃ½ video stream, resetnÃºÅ¥ obrazovku
            const video = document.getElementById('mainVideo');
            // Tu je to zloÅ¾itejÅ¡ie zistiÅ¥, Äi to bol on, ale pre jednoduchosÅ¥:
            // Ak uÅ¾ nemÃ¡me Å¾iadny aktÃ­vny video track v mainVideo, zobrazÃ­me placeholder
            if (video.srcObject && video.srcObject.active === false) {
                 resetToWaiting();
            }
            // Alebo jednoduchÅ¡ie - ak sa odpojÃ­ ten, Äo bol v mainVideo
            // PeerJS neposkytuje Ä¾ahko ID streamu pri close, tak skÃºsime resetnÃºÅ¥ ak stream umrel
             setTimeout(() => {
                if (!video.srcObject || video.srcObject.getTracks().every(t => t.readyState === 'ended')) {
                    resetToWaiting();
                }
             }, 500);
        }

        function resetToWaiting() {
            const video = document.getElementById('mainVideo');
            video.srcObject = null;
            document.getElementById('waiting-screen').style.display = 'flex';
        }

        function attemptPlay(video) {
            video.muted = true; 
            video.play().then(() => {
                // Ak sme Audio Master a toto je hlavnÃ© video, zapneme zvuk
                if (isAudioMaster) setTimeout(() => video.muted = false, 1000);
            }).catch(() => document.getElementById('play-overlay').style.display = 'flex');
        }

        function forcePlay() {
            const video = document.getElementById('mainVideo');
            if (video.srcObject) {
                video.muted = !isAudioMaster;
                video.play();
            }
            // SpustÃ­me aj vÅ¡etky audia v mixeri
            document.querySelectorAll('audio').forEach(a => a.play());
            
            document.getElementById('play-overlay').style.display = 'none';
        }
    </script>
</body>
</html>