<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor DIAGNOSTIC</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        #stats-box {
            position: absolute; top: 10px; left: 10px; 
            background: rgba(0,0,0,0.9); color: #00ff00; 
            padding: 15px; font-family: monospace; font-size: 14px;
            z-index: 9999; border: 2px solid #00ff00; pointer-events: none;
        }
        .stat-row { margin-bottom: 5px; }
        .big-alert { font-weight: bold; color: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h1>Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTI≈§</button>
    </div>

    <!-- ≈†tatistiky priamo na oƒçiach -->
    <div id="stats-box">
        <div class="stat-row">STAV: <span id="status-txt">ƒåak√°m...</span></div>
        <div class="stat-row">BITRATE: <span id="bitrate-txt" style="font-size: 20px; font-weight:bold;">0</span> kbps</div>
        <div class="stat-row">PAKETY: <span id="packets-txt">0</span></div>
        <div class="stat-row">ROZL√ç≈†ENIE: <span id="res-txt">0x0</span></div>
    </div>

    <div class="video-wrapper">
        <video id="mainVideo" style="width:100%; height:100%; object-fit:cover; background: #111;" autoplay playsinline muted></video>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2');

        const socket = io('/');
        let peer = null;
        let activeConnection = null;
        let statsInterval = null;
        
        // Konfigur√°cia - sk√∫sime in√Ω free TURN ak ten prv√Ω zlyh√°va
        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 2,
            config: { 
                iceTransportPolicy: 'relay', 
                'iceServers': [
                    // Google STUN
                    { urls: 'stun:stun.l.google.com:19302' },
                    // OpenRelay (Overen√Ω)
                    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
                ]
            }
        };

        function updateStatus(msg, color = 'white') {
            const el = document.getElementById('status-txt');
            el.innerText = msg;
            el.style.color = color;
            console.log(msg);
        }

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            updateStatus("Zap√≠nam kameru...", "yellow");

            navigator.mediaDevices.getUserMedia({ video: true, audio: isAudioMaster })
            .then(stream => {
                updateStatus("Prip√°jam na Cloud...", "yellow");
                initPeer(stream);
            })
            .catch(err => updateStatus("CHYBA KAMERY: " + err, "red"));
        }

        function initPeer(localStream) {
            peer = new Peer(peerConfig);

            peer.on('open', (id) => {
                updateStatus("ONLINE. ƒåak√°m na hovor...", "#00ff00");
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                updateStatus("üìû Prich√°dza hovor...", "cyan");
                call.answer(localStream);
                activeConnection = call.peerConnection;

                call.on('stream', remoteStream => {
                    updateStatus("üé¨ Stream prijat√Ω. Buffering...", "cyan");
                    const video = document.getElementById('mainVideo');
                    video.srcObject = remoteStream;
                    
                    // Tvrd√Ω pokus o play
                    video.muted = true;
                    video.play().then(() => {
                        if(isAudioMaster) setTimeout(() => video.muted = false, 1000);
                    }).catch(e => console.error(e));

                    // SPUSTENIE MERANIA D√ÅT
                    startBitrateMonitoring(activeConnection, video);
                });
            });
            
            peer.on('error', err => updateStatus("PEER ERROR: " + err, "red"));
        }

        // === TOTO JE TO KƒΩ√öƒåOV√â ===
        // T√°to funkcia sa p√Ωta prehliadaƒça: "Teƒç√∫ nejak√© d√°ta?"
        function startBitrateMonitoring(pc, videoElement) {
            if(statsInterval) clearInterval(statsInterval);
            
            let lastBytesReceived = 0;
            let lastTimestamp = Date.now();

            statsInterval = setInterval(async () => {
                if (!pc) return;
                
                try {
                    const stats = await pc.getStats();
                    let bytesNow = 0;
                    let packetsNow = 0;

                    stats.forEach(report => {
                        if (report.type === 'inbound-rtp' && report.kind === 'video') {
                            bytesNow = report.bytesReceived;
                            packetsNow = report.packetsReceived;
                        }
                    });

                    // V√Ωpoƒçet r√Ωchlosti
                    const timeNow = Date.now();
                    const durationSeconds = (timeNow - lastTimestamp) / 1000;
                    const bitrate = (((bytesNow - lastBytesReceived) * 8) / durationSeconds) / 1000; // kbps
                    
                    lastBytesReceived = bytesNow;
                    lastTimestamp = timeNow;

                    // Aktualiz√°cia UI
                    document.getElementById('bitrate-txt').innerText = Math.floor(bitrate);
                    document.getElementById('packets-txt').innerText = packetsNow;
                    document.getElementById('res-txt').innerText = videoElement.videoWidth + "x" + videoElement.videoHeight;

                    // DIAGNOSTIKA V RE√ÅLNOM ƒåASE
                    if (bitrate > 100) {
                        updateStatus("‚úÖ D√ÅTA TEƒå√ö (Obraz by mal √≠s≈•)", "#00ff00");
                        if(videoElement.videoWidth === 0) {
                            updateStatus("‚ö†Ô∏è D√ÅTA OK, ALE DEK√ìDER SP√ç", "orange");
                        }
                    } else if (bitrate === 0 && packetsNow > 0) {
                         updateStatus("‚ùå ZASEKNUT√â (0 kbps)", "red");
                    } else if (packetsNow === 0) {
                         updateStatus("‚ùå NIƒå NEPRICH√ÅDZA (Firewall?)", "red");
                    }

                } catch (e) {
                    console.error(e);
                }
            }, 1000);
        }
    </script>
</body>
</html>