<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Room Monitor</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h1>Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTIŤ SYSTÉM</button>
    </div>
    <video id="mainVideo" class="video-wrapper" autoplay playsinline></video>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2');
        
        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 2,
            config: { 'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ]}
        };

        const socket = io('/');
        let localStream = null;

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';

            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: isAudioMaster
            }).then(stream => {
                localStream = stream;
                initPeer();
            }).catch(err => alert("Kamera Error: " + err));
        }

        function initPeer() {
            // NEZADÁVAME ID - necháme vygenerovať náhodné
            const peer = new Peer(peerConfig);

            peer.on('open', (id) => {
                console.log("Moje ID je: " + id);
                // Oznámime serveru: "Ja som Monitor X a mám toto ID"
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                call.answer(localStream);
                call.on('stream', stream => {
                    const v = document.getElementById('mainVideo');
                    v.srcObject = stream;
                    v.muted = !isAudioMaster;
                    v.play();
                });
            });
            
            // Auto-reconnect pri výpadku
            peer.on('disconnected', () => peer.reconnect());
        }
    </script>
</body>
</html>