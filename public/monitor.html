<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Room Monitor</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h1 style="margin-bottom:20px;">Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTIŤ SYSTÉM</button>
    </div>
    
    <div class="video-wrapper">
        <video id="mainVideo" autoplay playsinline></video>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        
        const myPeerId = `tiky-monitor-${monitorId}`;
        const isAudioMaster = (monitorId === '2');
        const isSecure = location.protocol === 'https:';
        const serverPort = location.port ? parseInt(location.port) : (isSecure ? 443 : 80);

        // 1. Peer vytvoríme OKAMŽITE, nečakáme na kameru
        const peer = new Peer(myPeerId, {
            host: location.hostname,
            port: serverPort,
            path: '/peerjs',
            secure: isSecure,
            debug: 2,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { 
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443?transport=tcp",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ]
            }
        });

        let localStream = null;
        const socket = io('/');

        // 2. Spustenie systému
        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            socket.emit('join-room', myPeerId, 'monitor');

            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: isAudioMaster
            }).then(stream => {
                localStream = stream;
                console.log("Kamera pripravená.");
            }).catch(err => {
                alert("Chyba kamery: " + err);
            });
        }

        // 3. Inteligentné odpovedanie na hovor
        peer.on('call', call => {
            console.log("Niekto volá...");
            
            // Funkcia na zdvihnutie
            const answerCall = () => {
                if (localStream) {
                    call.answer(localStream);
                    call.on('stream', userVideoStream => {
                        const video = document.getElementById('mainVideo');
                        video.srcObject = userVideoStream;
                        video.muted = !isAudioMaster;
                        video.play().catch(e => console.log("Autoplay error:", e));
                    });
                } else {
                    // Ak kamera ešte nie je ready, skúsime to o 500ms znova
                    console.log("Čakám na kameru...");
                    setTimeout(answerCall, 500);
                }
            };
            
            answerCall();
        });
        
        peer.on('error', err => console.error("Monitor Error:", err));
    </script>
</body>
</html>