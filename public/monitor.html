<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor PRO</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
    <!-- Štart Overlay -->
    <div id="start-overlay">
        <img src="logo.svg" alt="UMIKT" class="logo-img" style="width: 200px;">
        <h1 style="color:var(--dark-blue); margin: 20px 0;">Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTIŤ SYSTÉM</button>
    </div>

    <div class="video-wrapper">
        <!-- Čakacia obrazovka (Placeholder) -->
        <div id="waiting-screen">
            <img src="logo.svg" alt="UMIKT" class="pulse-logo">
            <div id="waiting-text">Čakám na pripojenie účastníka...</div>
        </div>

        <video id="mainVideo" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline muted></video>
        
        <!-- Play Overlay (ak zlyhá autoplay) -->
        <div id="play-overlay" style="display:none;" onclick="forcePlay()">
            <div id="play-btn">▶</div>
            <h3 style="color:var(--dark-blue)">Klikni pre spustenie obrazu</h3>
        </div>
    </div>
    
    <!-- Audio Mixer pre Monitor 2 -->
    <div id="audio-mixer" style="display:none;"></div>
    
    <div id="debug-log" style="position: absolute; bottom: 0; left: 0; padding: 5px; color: #ccc; font-size: 10px; z-index:90;">Ready</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2');

        function log(msg) { document.getElementById('debug-log').innerText = msg; console.log(msg); }

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 1,
            config: { 
                iceTransportPolicy: 'all', 
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
                ]
            }
        };

        const socket = io('/');
        let localStream, peer;
        let activeCalls = {}; 

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            // Monitor 2 má audio zapnuté, ostatné vypnuté
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: isAudioMaster })
            .then(stream => { localStream = stream; initPeer(); }).catch(e => alert("Chyba: " + e));
        }

        function initPeer() {
            peer = new Peer(peerConfig);
            peer.on('open', id => { log("ID: " + id); socket.emit('register-monitor', monitorId, id); });

            peer.on('call', call => {
                log("Hovor od: " + call.peer);
                call.answer(localStream);
                activeCalls[call.peer] = call;
                call.on('stream', remoteStream => handleIncomingStream(call.peer, remoteStream));
                call.on('close', () => handleDisconnect(call.peer));
                call.on('error', () => handleDisconnect(call.peer));
            });
        }

        function handleIncomingStream(peerId, stream) {
            const hasVideo = stream.getVideoTracks().length > 0;
            if (hasVideo) {
                // Hlavné video
                document.getElementById('waiting-screen').style.display = 'none';
                const video = document.getElementById('mainVideo');
                video.srcObject = stream;
                attemptPlay(video);
            } else {
                // Iba audio (Mixer pre Mon 2)
                if (isAudioMaster) addAudioToMixer(peerId, stream);
            }
        }

        function addAudioToMixer(peerId, stream) {
            let existingAudio = document.getElementById('audio-' + peerId);
            if (existingAudio) return;
            const audio = document.createElement('audio');
            audio.id = 'audio-' + peerId; audio.srcObject = stream; audio.autoplay = true; audio.playsInline = true;
            document.getElementById('audio-mixer').appendChild(audio);
            audio.play().catch(e => console.log(e));
        }

        function handleDisconnect(peerId) {
            const audioEl = document.getElementById('audio-' + peerId);
            if (audioEl) audioEl.remove();
            setTimeout(() => {
                const video = document.getElementById('mainVideo');
                // Ak video stream skončil, obnovíme placeholder
                if (!video.srcObject || video.srcObject.getTracks().every(t => t.readyState === 'ended')) {
                    video.srcObject = null;
                    document.getElementById('waiting-screen').style.display = 'flex';
                }
            }, 500);
        }

        function attemptPlay(video) {
            video.muted = true; 
            video.play().then(() => { if (isAudioMaster) setTimeout(() => video.muted = false, 1000); })
            .catch(() => document.getElementById('play-overlay').style.display = 'flex');
        }

        function forcePlay() {
            const video = document.getElementById('mainVideo');
            if (video.srcObject) { video.muted = !isAudioMaster; video.play(); }
            document.querySelectorAll('audio').forEach(a => a.play());
            document.getElementById('play-overlay').style.display = 'none';
        }
    </script>
</body>
</html>