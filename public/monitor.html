<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor Debug</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.8); color: lime; font-family: monospace;
            overflow-y: scroll; padding: 10px; z-index: 9999; font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="start-overlay" class="start-overlay">
        <h1>Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()">SPUSTI≈§ (v2)</button>
    </div>
    <video id="mainVideo" class="video-wrapper" autoplay playsinline muted></video>
    <div id="debug-log">Log sa naƒç√≠ta...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        
        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
            console.log(msg);
        }

        const peerConfig = {
            host: '0.peerjs.com', port: 443, secure: true, debug: 3,
            config: { 'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ]}
        };

        const socket = io('/');
        let localStream = null;

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            log("≈†tartujem kameru...");

            navigator.mediaDevices.getUserMedia({ video: true, audio: true }) // Audio true, ale video element je muted
            .then(stream => {
                localStream = stream;
                log("Kamera OK. Prip√°jam na Cloud...");
                initPeer();
            })
            .catch(err => log("CRITICAL KAMERA ERROR: " + err));
        }

        function initPeer() {
            const peer = new Peer(peerConfig);

            peer.on('open', (id) => {
                log("‚úÖ Monitor ONLINE. Moje ID: " + id);
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                log("üìû PRICH√ÅDZAJ√öCI HOVOR od: " + call.peer);
                
                call.answer(localStream);
                log("‚úÖ Hovor zdvihnut√Ω (Answered)");

                // Sledovanie stavu spojenia
                call.peerConnection.onconnectionstatechange = () => {
                    log("üì° Stav spojenia: " + call.peerConnection.connectionState);
                };

                call.peerConnection.oniceconnectionstatechange = () => {
                    log("‚ùÑÔ∏è ICE Stav: " + call.peerConnection.iceConnectionState);
                };

                call.on('stream', stream => {
                    log("üé¨ Prij√≠mam video stream...");
                    const v = document.getElementById('mainVideo');
                    v.srcObject = stream;
                    
                    // Brut√°lny pokus o prehratie
                    const playPromise = v.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => log("‚ñ∂Ô∏è Video sa prehr√°va"))
                        .catch(error => log("‚ö†Ô∏è Play Error (Autoplay blok?): " + error));
                    }
                });
                
                call.on('error', err => log("‚ùå Call Error: " + err));
                call.on('close', () => log("üîå Hovor ukonƒçen√Ω druhou stranou"));
            });

            peer.on('error', err => log("‚ùå Peer Error: " + err));
            peer.on('disconnected', () => {
                log("‚ö†Ô∏è Odpojen√Ω od cloudu, sk√∫≈°am reconnect...");
                peer.reconnect();
            });
        }
    </script>
</body>
</html>