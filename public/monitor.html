<!DOCTYPE html>
<html lang="sk">
<head>
    <title>Monitor UNIVERSAL</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <!-- POU≈Ω√çVAME NAJNOV≈†IU VERZIU - FUNGUJE V≈†ADE -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: black; overflow: hidden; font-family: sans-serif; }
        
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.5); color: rgba(255,255,255,0.7); 
            pointer-events: none; z-index: 9000; font-size: 12px; padding: 5px;
        }

        /* Univerz√°lne overlay tlaƒçidlo (zobraz√≠ sa len keƒè treba) */
        #play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; 
            justify-content: center; align-items: center; z-index: 8000; cursor: pointer;
            flex-direction: column; color: white; text-align: center;
        }
        #play-btn {
            font-size: 60px; margin-bottom: 20px; color: #00aaff;
            border: 2px solid #00aaff; border-radius: 50%; width: 100px; height: 100px;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>
    <!-- ≈†tartovacie tlaƒçidlo -->
    <div id="start-overlay" class="start-overlay" style="display:flex; flex-direction:column; justify-content:center; align-items:center; position:absolute; top:0; left:0; width:100%; height:100%; background:black; z-index:9999;">
        <h1 style="color:white;">Monitor <span id="mon-num"></span></h1>
        <button class="btn-primary" onclick="startSystem()" style="padding:20px; font-size:20px; cursor:pointer;">SPUSTI≈§ SYST√âM</button>
    </div>

    <div class="video-wrapper" style="width:100vw; height:100vh; position: relative;">
        <!-- playsinline je kritick√© pre iOS, autoplay pre PC -->
        <video id="mainVideo" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline muted></video>
        
        <!-- Tlaƒçidlo pre pr√≠pad, ≈æe prehliadaƒç zablokuje autoplay (iOS/Android) -->
        <div id="play-overlay" onclick="forcePlay()">
            <div id="play-btn">‚ñ∂</div>
            <h3>Klikni pre obraz</h3>
        </div>
    </div>

    <div id="debug-log">System ready.</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const monitorId = params.get('id');
        document.getElementById('mon-num').innerText = monitorId;
        const isAudioMaster = (monitorId === '2');

        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML = `<div>${new Date().toLocaleTimeString()} - ${msg}</div>` + d.innerHTML;
        }

        // Univerz√°lna konfigur√°cia pre PC aj Mobil
        const peerConfig = {
            host: '0.peerjs.com', 
            port: 443, 
            secure: true, 
            debug: 1, // Menej spamu v konzole
            config: { 
                iceTransportPolicy: 'all', // Povol√≠ Wifi (Direct) aj 4G (Relay)
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
                ]
            }
        };

        const socket = io('/');
        let localStream = null;
        let peer = null;
        let currentStreamId = null;

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            log("Zap√≠nam kameru...");

            // Constraints pre PC aj Mobil
            const constraints = {
                video: { facingMode: "user" }, // Preferuje predn√∫ kameru na mobile
                audio: isAudioMaster
            };

            navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => {
                localStream = stream;
                log("Kamera be≈æ√≠. Prip√°jam cloud...");
                initPeer();
            }).catch(err => {
                log("‚ùå CHYBA KAMERY: " + err);
                alert("Pros√≠m povoƒæte kameru a mikrof√≥n!");
            });
        }

        function initPeer() {
            peer = new Peer(peerConfig);

            peer.on('open', (id) => {
                log("‚úÖ ONLINE. ID: " + id);
                socket.emit('register-monitor', monitorId, id);
            });

            peer.on('call', call => {
                log("üìû Prich√°dza hovor...");
                call.answer(localStream);

                call.on('stream', remoteStream => {
                    // Ochrana proti dvojit√©mu eventu
                    if (currentStreamId === remoteStream.id) return;
                    currentStreamId = remoteStream.id;

                    log("üé¨ Stream prijat√Ω.");
                    const video = document.getElementById('mainVideo');
                    video.srcObject = remoteStream;
                    
                    attemptUniversalPlay(video);
                });

                call.on('error', err => log("Call Error: " + err));
            });
            
            peer.on('error', err => {
                log("Peer Error: " + err.type);
                if (err.type === 'peer-unavailable' || err.type === 'network' || err.type === 'socket-error') {
                    log("Reconnect...");
                    peer.reconnect();
                }
            });
        }

        function attemptUniversalPlay(video) {
            // 1. V≈ædy najprv st√≠≈°ime (Prehliadaƒçe dovolia autoplay iba ak je muted)
            video.muted = true;
            
            const playPromise = video.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    log("‚ñ∂Ô∏è Video be≈æ√≠ (Muted).");
                    // 2. Ak video be≈æ√≠, sk√∫sime zapn√∫≈• zvuk (ak sme Monitor 2)
                    if (isAudioMaster) {
                        setTimeout(() => {
                            video.muted = false;
                            log("üîä Pokus o zvuk...");
                        }, 1000);
                    }
                })
                .catch(error => {
                    // 3. Ak autoplay zlyh√° (iPhone/Android), zobraz√≠me tlaƒçidlo
                    log("‚ö†Ô∏è Autoplay blokovan√Ω. ƒåak√°m na klik.");
                    document.getElementById('play-overlay').style.display = 'flex';
                });
            }
        }

        function forcePlay() {
            const video = document.getElementById('mainVideo');
            // Pri manu√°lnom kliku m√¥≈æeme rovno zapn√∫≈• zvuk
            video.muted = !isAudioMaster; 
            
            video.play().then(() => {
                log("‚ñ∂Ô∏è Spusten√© manu√°lne.");
                document.getElementById('play-overlay').style.display = 'none';
            }).catch(err => alert("Chyba prehr√°vania: " + err));
        }
    </script>
</body>
</html>